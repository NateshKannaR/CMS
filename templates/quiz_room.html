{% extends "base.html" %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('join_quiz') }}">Join Quiz</a></li>
<li class="breadcrumb-item active">{{ quiz.title }}</li>
{% endblock %}

{% block content %}
<div class="container">
    <div class="text-center mb-4">
        <h2>{{ quiz.title }}</h2>
        <p>Code: <strong>{{ quiz.quiz_code }}</strong></p>
    </div>

    <div id="waitingRoom" style="display: {% if quiz.status == 'waiting' %}block{% else %}none{% endif %}">
        <div class="text-center">
            <h4>Waiting for quiz to start...</h4>
            <p>Participants: {{ quiz.participants|length }}/{{ quiz.max_participants }}</p>
            <div class="spinner-border text-primary" role="status"></div>
        </div>
    </div>

    <div id="pausedRoom" style="display: {% if quiz.status == 'paused' %}block{% else %}none{% endif %}">
        <div class="text-center">
            <h4 class="text-warning">Quiz Paused</h4>
            <p>The teacher has paused the quiz. Please wait...</p>
            <div class="spinner-border text-warning" role="status"></div>
        </div>
    </div>

    <div id="quizArea" style="display: {% if quiz.status == 'active' %}block{% else %}none{% endif %}">
        <div class="card">
            <div class="card-header d-flex justify-content-between">
                <span>Question <span id="questionNumber">1</span> of {{ quiz.questions|length }}</span>
                <span>Score: <span id="currentScore">0</span></span>
            </div>
            <div class="card-body">
                <h4 id="questionText"></h4>
                <div id="optionsContainer" class="mt-3">
                    <!-- Options will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <div id="leaderboard" style="display: none">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-trophy"></i> Leaderboard</h4>
            </div>
            <div class="card-body">
                <div id="leaderboardList"></div>
                <div class="text-center mt-3">
                    <button id="nextQuestionBtn" class="btn btn-primary" style="display: none">Next Question</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentQuestion = 0;
let score = 0;
const quizId = '{{ quiz._id }}';
const questions = {{ quiz.questions | tojson }};

function loadQuestion(index) {
    if (index >= questions.length) {
        showFinalLeaderboard();
        return;
    }

    const question = questions[index];
    document.getElementById('questionNumber').textContent = index + 1;
    document.getElementById('questionText').textContent = question.question;
    
    const optionsContainer = document.getElementById('optionsContainer');
    optionsContainer.innerHTML = '';
    
    question.options.forEach((option, i) => {
        const button = document.createElement('button');
        button.className = 'btn btn-outline-primary btn-lg d-block w-100 mb-2';
        button.textContent = `${String.fromCharCode(65 + i)}. ${option}`;
        button.onclick = () => submitAnswer(i);
        optionsContainer.appendChild(button);
    });
}

function submitAnswer(answer) {
    fetch(`/submit_answer/${quizId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            answer: answer,
            question_index: currentQuestion
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.correct) {
            score += data.points;
            document.getElementById('currentScore').textContent = score;
        }
        
        currentQuestion++;
        
        if (currentQuestion % 5 === 0 || currentQuestion >= questions.length) {
            showLeaderboard();
        } else {
            setTimeout(() => loadQuestion(currentQuestion), 1000);
        }
    });
}

function showLeaderboard() {
    document.getElementById('quizArea').style.display = 'none';
    document.getElementById('leaderboard').style.display = 'block';
    
    // Show next question button if not final
    if (currentQuestion < questions.length) {
        document.getElementById('nextQuestionBtn').style.display = 'block';
        document.getElementById('nextQuestionBtn').onclick = () => {
            document.getElementById('leaderboard').style.display = 'none';
            document.getElementById('quizArea').style.display = 'block';
            document.getElementById('nextQuestionBtn').style.display = 'none';
            loadQuestion(currentQuestion);
        };
    }
}

function showFinalLeaderboard() {
    document.getElementById('quizArea').style.display = 'none';
    document.getElementById('leaderboard').style.display = 'block';
    document.querySelector('.card-header h4').innerHTML = '<i class="fas fa-crown"></i> Final Results';
}

// Start quiz if active
if ('{{ quiz.status }}' === 'active') {
    loadQuestion(0);
}
</script>
{% endblock %}